package internalhttp

import (
	"bytes"
	"context"
	"encoding/json"
	"errors"
	"net/http"
	"net/http/httptest"
	"testing"

	"github.com/whatafunc/Golang_Otus_Labs/hw12_13_14_15_calendar/internal/storage"
)

// MockLogger implements the Logger interface for testing
type MockLogger struct{}

func (m *MockLogger) Info(msg string) {}

// MockApplication implements the Application interface for testing.
type MockApplication struct {
	events map[int]storage.Event
}

func NewMockApplication() *MockApplication {
	return &MockApplication{
		events: make(map[int]storage.Event),
	}
}

func (m *MockApplication) CreateEvent(ctx context.Context, event storage.Event) error {
	m.events[event.ID] = event
	return nil
}

func (m *MockApplication) GetEvent(ctx context.Context, id int) (storage.Event, error) {
	event, exists := m.events[id]
	if !exists {
		return storage.Event{}, errors.New("event not found")
	}
	return event, nil
}

func (m *MockApplication) ListEvents(ctx context.Context, period storage.Period) ([]storage.Event, error) {
	events := make([]storage.Event, 0, len(m.events))
	for _, event := range m.events {
		events = append(events, event)
	}
	return events, nil
}

func (m *MockApplication) DeleteEvent(ctx context.Context, id int) error {
	if _, exists := m.events[id]; !exists {
		return errors.New("event not found")
	}
	delete(m.events, id)
	return nil
}

func (m *MockApplication) UpdateEvent(ctx context.Context, event storage.Event) error {
	if _, exists := m.events[event.ID]; !exists {
		return errors.New("event not found")
	}
	m.events[event.ID] = event
	return nil
}

func TestServer_HandleCreateEvent(t *testing.T) {
	logger := &MockLogger{}
	app := NewMockApplication()
	server := NewServer(logger, app, ":8080")

	testCases := []struct {
		name           string
		method         string
		requestBody    CreateEventRequest
		expectedStatus int
		expectedError  bool
	}{
		{
			name:   "successful event creation",
			method: http.MethodPost,
			requestBody: CreateEventRequest{
				ID:          1,
				Title:       "Test Event",
				Description: "Test Description",
			},
			expectedStatus: http.StatusCreated,
			expectedError:  false,
		},
		{
			name:   "missing title",
			method: http.MethodPost,
			requestBody: CreateEventRequest{
				ID:    2,
				Title: "",
			},
			expectedStatus: http.StatusBadRequest,
			expectedError:  true,
		},
		{
			name:           "wrong method",
			method:         http.MethodGet,
			requestBody:    CreateEventRequest{},
			expectedStatus: http.StatusMethodNotAllowed,
			expectedError:  true,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			body, _ := json.Marshal(tc.requestBody)
			req := httptest.NewRequest(tc.method, "/events", bytes.NewBuffer(body))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()

			server.handleCreateEvent(w, req)

			if w.Code != tc.expectedStatus {
				t.Errorf("expected status %d, got %d", tc.expectedStatus, w.Code)
			}

			if !tc.expectedError && tc.expectedStatus == http.StatusCreated {
				var response CreateEventResponse
				if err := json.Unmarshal(w.Body.Bytes(), &response); err != nil {
					t.Errorf("failed to unmarshal response: %v", err)
				}
				if !response.Success {
					t.Errorf("expected success=true, got %v", response.Success)
				}
			}
		})
	}
}

func TestServer_HandleDeleteEvent(t *testing.T) {
	logger := &MockLogger{}
	app := NewMockApplication()
	server := NewServer(logger, app, ":8080")

	app.CreateEvent(context.Background(), storage.Event{ID: 1, Title: "Event 1"})

	testCases := []struct {
		name           string
		method         string
		eventID        string
		expectedStatus int
	}{
		{"successful event deletion", http.MethodDelete, "1", http.StatusOK},
		{"delete non-existent event", http.MethodDelete, "999", http.StatusInternalServerError},
		{"invalid event ID", http.MethodDelete, "invalid", http.StatusBadRequest},
		{"wrong method", http.MethodPost, "1", http.StatusMethodNotAllowed},
		{"invalid URL format", http.MethodDelete, "", http.StatusBadRequest},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			url := "/api/events"
			if tc.eventID != "" {
				url += "/" + tc.eventID
			}
			req := httptest.NewRequest(tc.method, url, nil)
			w := httptest.NewRecorder()

			server.handleDeleteEvent(w, req)

			if w.Code != tc.expectedStatus {
				t.Errorf("expected %d, got %d", tc.expectedStatus, w.Code)
			}
		})
	}
}

func TestServer_HandleGetEvent(t *testing.T) {
	logger := &MockLogger{}
	app := NewMockApplication()
	server := NewServer(logger, app, ":8080")

	app.CreateEvent(context.Background(), storage.Event{ID: 1, Title: "Event 1"})

	testCases := []struct {
		name           string
		method         string
		eventID        string
		expectedStatus int
	}{
		{"successful event retrieval", http.MethodGet, "1", http.StatusOK},
		{"non-existent event", http.MethodGet, "999", http.StatusInternalServerError},
		{"invalid event ID", http.MethodGet, "invalid", http.StatusBadRequest},
		{"wrong method", http.MethodPost, "1", http.StatusMethodNotAllowed},
		{"invalid URL format", http.MethodGet, "", http.StatusBadRequest},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			url := "/api/events"
			if tc.eventID != "" {
				url += "/" + tc.eventID
			}
			req := httptest.NewRequest(tc.method, url, nil)
			w := httptest.NewRecorder()

			server.handleGetEvent(w, req)

			if w.Code != tc.expectedStatus {
				t.Errorf("expected %d, got %d", tc.expectedStatus, w.Code)
			}
		})
	}
}

func TestServer_HandleUpdateEvent(t *testing.T) {
	logger := &MockLogger{}
	app := NewMockApplication()
	server := NewServer(logger, app, ":8080")

	app.CreateEvent(context.Background(), storage.Event{ID: 1, Title: "Old Title"})

	testCases := []struct {
		name           string
		method         string
		eventID        string
		updateBody     storage.Event
		expectedStatus int
	}{
		{
			"successful event update",
			http.MethodPut,
			"1",
			storage.Event{ID: 1, Title: "New Title"},
			http.StatusOK,
		},
		{
			"update non-existent event",
			http.MethodPut,
			"999",
			storage.Event{ID: 999, Title: "Does not exist"},
			http.StatusInternalServerError,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			body, _ := json.Marshal(tc.updateBody)
			req := httptest.NewRequest(tc.method, "/api/events/"+tc.eventID, bytes.NewBuffer(body))
			req.Header.Set("Content-Type", "application/json")
			w := httptest.NewRecorder()

			server.handleUpdateEvent(w, req)

			if w.Code != tc.expectedStatus {
				t.Errorf("expected %d, got %d", tc.expectedStatus, w.Code)
			}
		})
	}
}

func TestServer_HandleListEvents(t *testing.T) {
	logger := &MockLogger{}
	app := NewMockApplication()
	server := NewServer(logger, app, ":8080")

	app.CreateEvent(context.Background(), storage.Event{ID: 1, Title: "Event 1"})
	app.CreateEvent(context.Background(), storage.Event{ID: 2, Title: "Event 2"})

	req := httptest.NewRequest(http.MethodGet, "/api/events", nil)
	w := httptest.NewRecorder()

	server.handleListEvents(w, req)

	if w.Code != http.StatusOK {
		t.Errorf("expected %d, got %d", http.StatusOK, w.Code)
	}
}
